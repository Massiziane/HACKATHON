// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String @id @default(cuid())
  email     String @unique
  password  String
  firstName String
  lastName  String
  role      Role   @default(etudiant)

  formations Formation[]
  cours      Cours[]     @relation("TeacherCours") // ajouté relation inverse
  lecons     Lecon[]     @relation("TeacherLecon") // ajouté relation inverse
  quizzes    Quiz[] // un utilisateur peut avoir plusieurs quiz
  progresses Progress[]

  createdAt  DateTime @default(now())
  modifiedAt DateTime @updatedAt
}

enum Role {
  admin
  enseignant
  etudiant
  mentor
}

model Categorie {
  id    String  @id @default(cuid())
  name  String  @unique
  cours Cours[]

  formations Formation[] @relation("FormationCategories")
}

model Formation {
  id          String  @id @default(cuid())
  title       String
  description String?

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  cours Cours[]

  inheritedCategories Categorie[] @relation("FormationCategories")

  createdAt  DateTime @default(now())
  modifiedAt DateTime @updatedAt
}

model Cours {
  id          String  @id @default(cuid())
  title       String
  description String?

  teacherId String
  teacher   User   @relation("TeacherCours", fields: [teacherId], references: [id], onDelete: Cascade)

  formationId String? // ← devient nullable
  formation   Formation? @relation(fields: [formationId], references: [id], onDelete: SetNull)
  // ← ne supprime pas les cours, met juste null

  categorieId String
  categorie   Categorie @relation(fields: [categorieId], references: [id], onDelete: Restrict)

  progresses Progress[]

  lecons Lecon[]

  createdAt  DateTime @default(now())
  modifiedAt DateTime @updatedAt
}

model Lecon {
  id          String  @id @default(cuid())
  title       String
  description String?
  body        String?

  teacherId String
  teacher   User   @relation("TeacherLecon", fields: [teacherId], references: [id], onDelete: Cascade)

  coursId String
  cours   Cours  @relation(fields: [coursId], references: [id], onDelete: Cascade)

  quiz   Quiz?   @relation("LeconQuiz", fields: [quizId], references: [id])
  quizId String? @unique // garantit 1 quiz max par lecon
}

model Quiz {
  id          String  @id @default(cuid())
  title       String
  description String?

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id])

  lecon Lecon? @relation("LeconQuiz") // opposé pour Lecon.quiz

  questions Question[]

  createdAt  DateTime @default(now())
  modifiedAt DateTime @updatedAt
}

model Question {
  id      String    @id @default(cuid())
  text    String
  options Reponse[]

  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model Reponse {
  id           String  @id @default(cuid())
  text         String
  bonneReponse Boolean

  question   Question @relation(fields: [questionID], references: [id], onDelete: Cascade)
  questionID String
}

model Progress {
  id        String @id @default(cuid())
  studentId String
  student   User   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  coursId String
  cours   Cours  @relation(fields: [coursId], references: [id], onDelete: Cascade)

  completed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, coursId])
}
